TITLE='Conflict Report - Participants Scheduled Outside Available Times'
DESCRIPTION='Show all participant-sessions scheduled outside set of times participant has listed as being available.'
CONFLICTWANTS=1
QUERY="
Select 
	FOO.badgeid, 
	P.pubsname, 
	TR.trackname, 
	concat('<a href=StaffAssignParticipants.php?selsess=',FOO.sessionid,'>', FOO.sessionid,'</a>') as Sessionid, 
	concat('<a href=MaintainRoomSched.php?selroom=',R.roomid,'>', R.roomname,'</a>') as Roomname, 
	DATE_FORMAT(ADDTIME('2011-01-14 00:00:00',FOO.starttime),'%a %l:%i %p') as 'Start Time', 
	DATE_FORMAT(ADDTIME('2011-01-14 00:00:00',FOO.endtime),'%a %l:%i %p') as 'End Time', 
	FOO.hours as 'Ttl. Hours Avail.' 
  from (
    Select SCHD.badgeid, 
           SCHD.trackid, 
           SCHD.sessionid, 
           SCHD.starttime, 
           SCHD.endtime, 
           SCHD.roomid, 
           PAT.availabilitynum, 
           HRS.hours 
    from (
      Select POS.badgeid, 
	     SCH.sessionid, 
             SCH.starttime, 
	     SCH.roomid, 
	     ADDTIME(SCH.starttime,S.duration) as endtime, 
	     S.trackid 
        from Schedule SCH, 
	     ParticipantOnSession POS, 
	     Sessions S 
       where SCH.sessionid = POS.sessionid 
         and SCH.sessionid = S.sessionid) as SCHD 
 left join ParticipantAvailabilityTimes PAT 
        on SCHD.badgeid = PAT.badgeid 
       and SCHD.starttime>=PAT.starttime 
       and SCHD.endtime<=PAT.endtime 
  left join (Select badgeid, sum(hour(subtime(endtime,starttime))) as hours 
               from ParticipantAvailabilityTimes 
           group by badgeid) as HRS 
      on SCHD.badgeid=HRS.badgeid 
  having PAT.availabilitynum is null) as FOO, 
  Tracks TR, 
 Participants P, 
   Rooms R 
  where FOO.badgeid = P.badgeid 
    and FOO.trackid = TR.trackid 
    and FOO.roomid = R.roomid 
  having FOO.hours is not NULL 
  order by cast(FOO.badgeid as unsigned);"
