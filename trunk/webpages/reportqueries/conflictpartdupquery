TITLE='Conflict Report - Participant Double Booked'
DESCRIPTION='Find all instances where a participant is scheduled to be in two or more places at once'
CONFLICTWANTS=1
QUERY="
   SELECT concat(P.pubsname, '(', P.badgeid, ')') as Participant,
          ' ',
          TA.trackname as 'Track A', 
          concat('<a href=MaintainRoomSched.php?selroom=',RA.roomid,'>', RA.roomname,'</a>') as 'Room A', 
          concat('<a href=StaffAssignParticipants.php?selsess=',Asess,'>', Asess,'</a>') as 'Session ID A', 
          DATE_FORMAT(ADDTIME('2009-01-16 00:00:00',Astart),'%a %l:%i %p') as 'Start Time A', 
          left(Adur,5) as 'Dur A',
          ' ',
          TB.trackname as 'Track B', 
          concat('<a href=MaintainRoomSched.php?selroom=',RB.roomid,'>', RB.roomname,'</a>') as 'Room B', 
          concat('<a href=StaffAssignParticipants.php?selsess=',Bsess,'>', Bsess,'</a>') as 'Session ID B', 
          DATE_FORMAT(ADDTIME('2009-01-16 00:00:00',Bstart),'%a %l:%i %p') as 'Start Time B',
          left(Bdur,5) as 'Dur B'
     FROM Rooms RA, 
          Rooms RB, 
          Tracks TA, 
          Tracks TB, 
	  Participants P,
    (SELECT POSA.badgeid, 
            SCHA.roomid AS Aroom, 
            SCHA.sessionid AS Asess, 
            SCHA.starttime AS Astart, 
            ADDTIME(SCHA.starttime, SA.duration) AS Aend, 
            SA.trackid AS Atrack, 
	    SA.duration AS Adur,
            SCHB.sessionid AS Bsess, 
            SCHB.roomid AS Broom, 
            SCHB.starttime AS Bstart, 
            ADDTIME(SCHB.starttime, SB.duration) AS Bend, 
            SB.trackid AS Btrack,
	    SB.duration AS Bdur
       FROM ParticipantOnSession POSA, 
            ParticipantOnSession POSB, 
            Schedule SCHA, 
            Schedule SCHB, 
            Sessions SA, 
            Sessions SB 
      where POSA.sessionid = SA.sessionid 
        and SCHA.sessionid=POSA.sessionid 
        and POSB.sessionid = SB.sessionid 
        and SCHB.sessionid=POSB.sessionid 
        and POSA.badgeid=POSB.badgeid 
        and (SCHA.starttime<SCHB.starttime 
           or (SCHA.starttime=SCHB.starttime 
           and SCHA.sessionid<SCHB.sessionid)) 
       and ADDTIME(SCHA.starttime, SA.duration)>SCHB.starttime 
       and POSA.sessionid<>POSB.sessionid) as Foo 
   where Aroom=RA.roomid 
     and P.badgeid=Foo.badgeid
     and Broom=RB.roomid 
     and TA.trackid=Atrack 
     and TB.trackid=Btrack 
order by cast(P.badgeid as unsigned), 
         Astart;"
